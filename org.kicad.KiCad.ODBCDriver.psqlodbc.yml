id: org.kicad.KiCad.ODBCDriver.psqlodbc
branch: stable
runtime: org.kicad.KiCad
runtime-version: stable
sdk: org.freedesktop.Sdk//24.08
build-extension: true
appstream-compose: false
build-options:
  prefix: /app/extensions/ODBCDriver/psqlodbc
  prepend-path: /app/extensions/ODBCDriver/psqlodbc/bin
modules:
  - name: libpq
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
    # Copying build instructions for the libpg client library from
    # https://src.fedoraproject.org/rpms/libpq/blob/rawhide/f/libpq.spec
    config-opts:
      - --disable-rpath
      #- --with-ldap  # Disabling until somebody actually needs it
      - --with-openssl
      #- --with-gssapi  # Disabling until somebody actually needs it
      - --enable-nls
      - --without-readline
    sources:
      - type: git
        url: https://git.postgresql.org/git/postgresql.git
        commit: 7885b94dd81b98bbab9ed878680d156df7bf857f
        tag: REL_17_6
        x-checker-data:
          type: git
          tag-pattern: ^REL_([\d_]+)$
  - name: psqlodbc
    config-opts:
      - --with-libpq=/app/extensions/ODBCDriver/psqlodbc/bin/pg_config
    post-install:
      - install -d ${FLATPAK_DEST}/template
      - |
        cat << EOF > ${FLATPAK_DEST}/template/psqlodbcw.ini
        [PostgreSQL Unicode]
        Description=PostgreSQL ODBC driver (Unicode version)
        Driver=${FLATPAK_DEST}/lib/psqlodbcw.so
        EOF
      - |
        cat << EOF > ${FLATPAK_DEST}/template/psqlodbca.ini
        [PostgreSQL ANSI]
        Description=PostgreSQL ODBC driver (ANSI version)
        Driver=${FLATPAK_DEST}/lib/psqlodbca.so
        EOF
      - >
        install -Dm644 --target-directory=${FLATPAK_DEST}/share/metainfo \
          org.kicad.KiCad.ODBCDriver.psqlodbc.metainfo.xml
    sources:
      - type: git
        url: https://github.com/postgresql-interfaces/psqlodbc.git
        commit: 251c8e8200c7a030fa46e59429d3fec7a73de4ec
        tag: REL-17_00_0006
        x-checker-data:
          is-main-source: true
          type: git
          tag-pattern: ^REL-([\d_]+)$
      - type: file
        path: org.kicad.KiCad.ODBCDriver.psqlodbc.metainfo.xml
